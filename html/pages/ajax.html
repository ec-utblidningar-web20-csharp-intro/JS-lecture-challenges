<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Funktioner</title>
  <base href="../../">

  <!-- Whole website -->
  <link rel="stylesheet" href="css/general.css">
  <script src="js/component.js"></script>

  <!-- Page specific -->
  <link rel="stylesheet" href="css/pages/ajax.css">

  <script defer="true" src="js/pages/ajax_övning.js"></script>
  <script defer="true" src="js/pages/ajax_frågor.js"></script>

  <link rel="stylesheet" href="lib/highlight/styles/xcode.css">
  <script src="lib/highlight/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
</head>

<body>
  <insert data-component="nav"></insert>
  <main class="fx fx-center fx-col">
    <section>
      <h2>Fråga 1</h2>
      <p>Använd <a href="https://javascript.info/url" target="_blank">URL</a> objektet för att bygga ett API
        anrop till <a href="https://openweathermap.org/current#name" target="_blank">OpenWeather</a>
        för att få tag på info om vädret i staden du är just nu. Skriv ut url:n i frågefönstret.
      </p>
      <p>
        Lek runt med URL objektet i dev konsollen inne i Chrome innan
        du löser uppgiften. Då får du en bra insyn i vad som finns i URL objektet
        och vad som händer när man kallar på metoderna och ändrar på properties.
      </p>
      <ul>
        <li>Börja med pre<code>new URL('https://api.openweathermap.org/data/2.5/weather')</code></li>
        <li>Fyll på search parametrar via metoderna i url.searchParams</li>
        <li>Bygg en url som använder alla parametrar under 'Parameters'</li>
      </ul>
      <h3>Bonus:</h3>
      <p>Prompta att användaren får välja stad via
        <a href="https://www.w3schools.com/jsref/met_win_prompt.asp" target="_blank">prompt()</a>
      </p>
      <div id="q1" class="fx fx-row fx-center fx-space">
        <pre id="q1_out">Skriv url:n här</pre>
      </div>
      <details>
        <summary>Facit</summary>
        <pre><code class="javascript">
  let url = new URL("https://api.openweathermap.org/data/2.5/weather");

  url.searchParams.set("q", "Varberg,Sweden");
  url.searchParams.set("appid", "din_hashkod_här");
  url.searchParams.set("mode", "json");
  url.searchParams.set("units", "metric");
  url.searchParams.set("lang", "se");

  for (let [key, val] of url.searchParams) {
    console.log(`${key}:${val}`);
  }

  document.querySelector("#q1_out").innerText = url;</code></pre>
      </details>
    </section>
    <section>
      <h2>Fråga 2</h2>
      <p>Skapa ett <a href="https://javascript.info/xmlhttprequest" target="_blank">XMLHttpRequest</a> objekt för att
        skicka en
        begäran till url:n i Fråga 1
      </p>
      <p>
        Här är de viktigaste stegen:
      </p>
      <ol>
        <li>Skapa ett objekt med <code>new</code></li>
        <li>
          kalla på <code>open()</code> för att ställa in destination
        </li>
        <li>
          bind onload eventet för att göra något med resultatet. (p.s. kolla status kod 200)
        </li>
        <li>
          bind onerror eventet för att debugga om något går snett
        </li>
        <li>
          kalla på <code>send()</code> för att påbörja kommunikationen
        </li>
      </ol>
      <h3>Bonus:</h3>
      <p>Pröva att binda till onprogress eventet och skapa någon
        slags enkel visuell indikator över hur långt nerladdningen kommit.
        <a href="ftp://speedtest.tele2.net/">Tele2</a> har en en bra FTP server
        som kan användas för att testa ladda ner större filer. Ta bara
        länken "ftp://speedtest.tele2.net/" + filnamnet på den filen du vill ladda ner.
      </p>
      <div id="q2" class="fx fx-row fx-center fx-space">
        <pre id="q2_out">Skriv ut resultatet här</pre>
      </div>
      <details>
        <summary>Facit</summary>
        <pre><code class="javascript">  {
    let out = document.querySelector("#q2_out");
    let xhr = new XMLHttpRequest();

    xhr.open("GET", url);
    xhr.responseType = "json";

    xhr.onload = function (e) {
      //'e.target' kommer här att peka på XMLHttpRequest objektet
      console.log(`Weather request status: ${e.target.status} ${e.target.statusText}`);

      if(e.target.status === 200){ // Begäran lyckades
        let jsObjekt = e.target.response;
        out.innerText = JSON.stringify(jsObjekt, null, ' ');
      }
    };

    xhr.onerror = function (e) {
      console.log(url.origin + " could not be reached");
    };

    xhr.send();
  }</code></pre>
      </details>
    </section>
    <section>
      <h2>Fråga 3</h2>
      <p>Nu är det dags att göra arbete som tar längre tid.
        I detta fallet handlar det om att flytta en boll
        runt alla hörn längs en bana när man klickar på den.
        Använd <a href="https://www.w3schools.com/jsref/met_win_settimeout.asp"
          target="_blank"><code>setTimeout()</code></a>
        för att sprida ut dina instruktioner i tid.
      </p>
      <p>Knepet här ligger i att
      </p>
      <div id="q3" class="fx fx-row fx-center">
        <div class="edge"><div class="ball"></div></div>
      </div>
      <details>
        <summary>Facit</summary>
        <pre><code class="javascript">{
    let b1 = document.querySelector("#q3_b1");
    let b2 = document.querySelector("#q3_b2");
    let b3 = document.querySelector("#q3_b3");

    b1.onclick = function (){
        let jsonSource = document.querySelector("#q3_j1");
        let dude = JSON.parse(jsonSource.innerText);

        alert(
            `${dude.firstName} ${dude.lastName} ${dude.isAlive ? 'lives':'died'} in ${dude.address.city}.
He ${dude.isAlive ? 'has':'had'} ${dude.children.length} children.`);
    };

    b2.onclick = function (){
        let jsonSource = document.querySelector("#q3_j2");
        let info = JSON.parse(jsonSource.innerText);
        let weather = info.weather[0];

        alert(
            `The weather today (${info.dt}) in ${info.name} city is 
${weather.main} with a ${weather.description}.`);
    };

    b3.onclick = function (){
        let textbox = document.querySelector("#q3_out");
        textbox.innerHTML = `<pre>${JSON.stringify(teacher, null, ' ')}</pre>`;
        };
        }</code></pre>
      </details>
    </section>
  </main>
  <script>
    // Ett litet script för att fixa facitkodens formatering
    for (let elem of document.querySelectorAll(".javascript")) {
      elem.innerHTML = elem.innerHTML.replace(/</g, "&lt;");
    };
  </script>
</body>

</html>